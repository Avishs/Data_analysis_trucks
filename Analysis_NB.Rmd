---
title: "Analysis of TVC and Toll Survey Data"
author:
- TRIPC (IIT Delhi)
- APAG
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
---

```{r}
# set working directory same as script directory
script_path <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(script_path)

# load up the packages we will need: 
library(tidyverse)
library(readxl)
library(ggraph)
library(knitr)
library(kableExtra)
```

# Truck Traffic Patterns in Delhi: Insights from RFID Toll Data

```{r}
# reading in the data
MCD_1 <- read_excel("Analysis_TVC/Input/MCD data_trucks_april 2025.xlsx", sheet = "01-To-09", skip = 1)
MCD_2 <- read_excel("Analysis_TVC/Input/MCD data_trucks_april 2025.xlsx", sheet = "10-To-18", skip = 1)
MCD_3 <- read_excel("Analysis_TVC/Input/MCD data_trucks_april 2025.xlsx", sheet = "19-To-26", skip = 1)
MCD_4 <- read_excel("Analysis_TVC/Input/MCD data_trucks_april 2025.xlsx", sheet = "27-To-30", skip = 1)

# merge files into one dataframe
MCD <- bind_rows(MCD_1, MCD_2, MCD_3, MCD_4)

# Remove temporary variables
rm(MCD_1, MCD_2, MCD_3, MCD_4)

# Extract day of month and hour of trip
MCD$Date <- day(MCD$`Trip Date`)
MCD$Hour <- hour(MCD$`Trip Date`)
MCD$Month <- month(MCD$`Trip Date`)

# correcting fuel type names
MCD$`Fuel Type` <- str_to_upper(MCD$`Fuel Type`)

# Weekday vs weekend
MCD <- MCD %>%
  mutate(weekday = wday(`Trip Date`, label = TRUE),
         weekend = if_else(weekday %in% c("Sat", "Sun"), "Weekend", "Weekday"))

# Taking only the trucks we need
MCD_truck <- 
  MCD %>%
  filter(`Vehicle Class` %in% c("Truck 2 axle","MAV 4 AXLE","MAV 3 axle")) %>%
  droplevels()
```

## Some basic statistics

```{r}
summary_stats_all <- list(
  total_days   = n_distinct(MCD$Date),
  total_plazas = n_distinct(MCD$Plaza),
  total_trips  = nrow(MCD),
  total_vehicle_types = table(MCD$`Vehicle Class`)
)

summary_stats_all

```

```{r}
summary_stats_truck <- list(
  total_days   = n_distinct(MCD_truck$Date),
  total_plazas = n_distinct(MCD_truck$Plaza),
  total_trips  = nrow(MCD_truck),
  total_vehicle_types = table(MCD_truck$`Vehicle Class`)
)

summary_stats_truck

```

-   total number of truck entries vs overall vehicle entries into Delhi
-   \% unique entries - total num of unique truck entries vs unique vehicle entries into Delhi

```{r}
# Total entries
total_entries <- nrow(MCD_truck)

# Unique vehicle entries
unique_entries <- n_distinct(MCD_truck$RFID)

# Share of unique vehicles
unique_share <- unique_entries / total_entries * 100

data.frame(
  Metric = c("Total Entries", "Unique Vehicles", "% Unique Vehicles"),
  Value = c(total_entries, unique_entries, round(unique_share))
)
```

1.  Trips per truck - 1.1 Avg. no. of entries per unique truck - total entries divided by unique trucks 1.2 % of trucks seen once, 2-5 times, 5-10 times, etc. - count of trucks in each frequency bucket divided by total unique trucks
2.  Share of traffic generated by a small % of frequent trucks - % of trucks (unique vehicles) and % of total trips (entries) they contribute
3.  Avg. time between consecutive / repeat entries

```{r}
trips_per_truck <- MCD_truck %>%
  count(RFID, name = "num_trips")

# Summary statistics
summary(trips_per_truck$num_trips)

# Frequency distribution (bucketed)
trip_dist <- trips_per_truck %>%
  mutate(bucket = case_when(
    num_trips == 1 ~ "1 time",
    num_trips <= 5 ~ "2–5 times",
    num_trips <= 10 ~ "6–10 times",
    TRUE ~ "10+ times"
  )) %>%
  count(bucket) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

trip_dist
```

```{r}
# Sort trucks by number of trips
truck_rank <- trips_per_truck %>%
  arrange(desc(num_trips)) %>%
  mutate(
    cum_trucks = row_number() / n(),
    cum_trips  = cumsum(num_trips) / sum(num_trips)
  )

# What share of trips comes from top 10% of trucks?
top10_share <- truck_rank %>%
  filter(cum_trucks <= 0.1) %>%
  summarise(share = max(cum_trips)*100)

top10_share

```

For every data point and insight, compare total entries with unique entries to identify discrepancies. For e.g., if \~80% of total entries are from CNG trucks but only \~50% of unique trucks are CNG (as we've seen), it implies that CNG trucks are more likely to make repeat trips. Similar comparisons across other data-points can reveal similar insights.

### Timestamps

1.  Daily/hourly traffic flow - either no. of trucks or % of trucks against total vehicles hourly / daily
2.  Weekday vs weekend traffic flow - no. or % of trucks on weekday & weekend

```{r}
# Daily totals
daily_flow <- MCD_truck %>%
  count(Date) %>% 
  rename(Trips = n)

# Table
knitr::kable(daily_flow, caption = "Total truck trips per day (April 2025)")

```

```{r}
# Identify weekend days (Saturday/Sunday)
weekend_days <- MCD_truck %>%
  mutate(day = Date, 
         weekday = lubridate::wday(`Trip Date`, label = TRUE)) %>%
  distinct(day, weekday) %>%
  filter(weekday %in% c("Sat", "Sun"))

# Build shaded regions for weekends
weekend_rects <- weekend_days %>%
  mutate(xmin = day - 0.5, xmax =      day + 0.5,
         ymin = -Inf, ymax = Inf)

ggplot(daily_flow, aes(x = Date, y = Trips)) +
  # Shade weekends
  geom_rect(
    data = weekend_rects,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    inherit.aes = FALSE,
    fill = "lightgray", alpha = 0.4
  ) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "darkblue") +
  labs(
    title = "Daily Truck Traffic Flow (Weekends Shaded)",
    x = "Day of April 2025",
    y = "Number of Trips"
  ) +
  theme_minimal(base_size = 12)

```

```{r}
# Hourly totals
hourly_flow <- MCD_truck %>%
  count(Hour) %>%
  rename(Trips = n) %>%
  mutate(perc = round(Trips / sum(Trips) * 100, 1))

# Table
knitr::kable(hourly_flow, caption = "Hourly distribution of truck trips")
```

```{r}
ggplot(hourly_flow, aes(x = Hour, y = Trips)) +
  geom_col(fill = "orange") +
  geom_text(aes(label = paste0(perc, "%")), vjust = -0.5, size = 2) +
  labs(
    title = "Hourly Truck Traffic Flow",
    x = "Hour of Day",
    y = "Number of Trips"
  ) +
  theme_minimal(base_size = 12)

```

```{r}
weekday_flow <- MCD_truck %>%
  count(weekend)%>%
  mutate(Percentage = round(n / sum(n) * 100, 1))

# Table
knitr::kable(weekday_flow, caption = "Weekday vs. Weekend truck traffic")
```

```{r}
ggplot(weekday_flow, aes(x = weekend, y = n, fill = weekend)) +
  geom_col() +
  geom_text(aes(label = paste0(Percentage, "%")), vjust = -0.5, size = 4) +
  labs(
    title = "Weekday vs. Weekend Truck Traffic",
    x = "",
    y = "Number of Trips"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")
```

#### Truck Timing Compliance and Diurnal Patterns

We overlay regulatory time windows onto the hourly traffic distribution to observe how vehicle types align with permitted travel times.

```{r hourly-flow-shaded, fig.width=7, fig.height=4}
# Assume 'hourly_flow' exists with counts by 'Hour'

# Define restricted windows
restriction_lgv <- data.frame(xmin = c(7, 17), xmax = c(11, 23), ymin = 0, ymax = max(hourly_flow$Trips))
restriction_hgv <- data.frame(xmin = 7, xmax = 23, ymin = 0, ymax = max(hourly_flow$Trips))

ggplot(hourly_flow, aes(x = Hour, y = Trips)) +
  # LGV restricted windows
  geom_rect(data = restriction_lgv, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
            fill = "red", alpha = 0.2, inherit.aes = FALSE) +
  # HGV restricted window
  geom_rect(data = restriction_hgv, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
            fill = "blue", alpha = 0.1, inherit.aes = FALSE) +
  geom_col(fill = "orange") +
  labs(
    title = "Hourly Truck Traffic with Regulatory Restriction Windows",
    x = "Hour of Day",
    y = "Number of Trips"
  ) +
  theme_minimal()
```

LGVs (light goods vehicles) are not allowed from 7 am–11 am and 5 pm–11 pm, marked by red shading.

HGVs/MGVs face longer restrictions during daytime—blue shading demonstrates these hours.

Traffic peaks around midnight–early morning correspond to lifted restrictions, as reflected by our data.

Conversely, major troughs align with restricted intervals, indicating compliance or enforcement effectiveness.

### Toll Plaza

-   \% of total entries by plaza (for the whole month)
-   \% of unique entries by plaza (for the whole month)
-   
    1.  No. of repeat trips per plaza

```{r}
plaza_dist <- MCD_truck %>%
  count(Plaza) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

plaza_dist

```

### Vehicle Class

```{r}
Vehicle_type <-
  MCD_truck %>% 
  distinct(RFID, .keep_all = TRUE) %>% 
  group_by(`Vehicle Class`) %>% 
  summarise(counts = n()) %>% 
  mutate(percentage = counts / sum(counts) * 100)

ggplot(Vehicle_type, aes(x = reorder(`Vehicle Class`, c(2,3,1)), y = counts, fill = `Vehicle Class`)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            vjust = -0.5, size = 4) +
  labs(
    title = "Distribution of Selected Vehicle Types",
    x = "Vehicle Class",
    y = "Number of Vehicles"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

```

1.  Axle distribution - % of all trips made by 2-axle vs. 3-axle vs. 4+ axle trucks

(do this for total and unique entries)

```{r}
# Total trips distribution
axle_total <- MCD_truck %>%
  count(`Vehicle Class`) %>%
  mutate(perc = round(n / sum(n) * 100, 1),
         type = "Total Trips")

# Unique trucks distribution
axle_unique <- MCD_truck %>%
  distinct(RFID, .keep_all = TRUE) %>%
  count(`Vehicle Class`) %>%
  mutate(perc = round(n / sum(n) * 100, 1),
         type = "Unique Trucks")

# Nicely formatted tables
axle_total_tbl <- axle_total %>%
  select(-type) %>% 
  rename(`Vehicle Class` = `Vehicle Class`, `Trips` = n, `% of Trips` = perc)

axle_unique_tbl <- axle_unique %>%
  select(-type) %>% 
  rename(`Vehicle Class` = `Vehicle Class`, `Unique Trucks` = n, `% of Unique Trucks` = perc)

```

```{r}
knitr::kable(axle_total_tbl, caption = "Distribution of all trips by axle category")
```

```{r}
knitr::kable(axle_unique_tbl, caption = "Distribution of unique trucks by axle category")
```

```{r}
# Combine for plotting
axle_combined <- bind_rows(axle_total, axle_unique)

ggplot(axle_combined, aes(x = `Vehicle Class`, y = perc, fill = type)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = paste0(perc, "%")), 
            position = position_dodge(width = 0.9), vjust = -0.3, size = 3) +
  labs(
    title = "Axle Distribution: Total Trips vs Unique Trucks",
    x = "Vehicle Class",
    y = "Percentage of Entries",
    fill = "Measure"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

```

### RFID Tag Type

1.  \% split of trip-based vs. periodic
2.  No. of repeat entry trucks who've opted for RFID

```{r}
# Split by tag type
rfid_split <- MCD_truck %>%
  count(`Pass Type`) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

# Table
knitr::kable(
  rfid_split %>% rename(Trips = n, `% of Trips` = perc),
  caption = "RFID Tag Type split across all trips"
)

# Plot
ggplot(rfid_split, aes(x = `Pass Type`, y = perc, fill = `Pass Type`)) +
  geom_col() +
  geom_text(aes(label = paste0(perc, "%")), vjust = -0.5, size = 4) +
  labs(
    title = "Distribution of RFID Tag Types",
    x = "Tag Type",
    y = "Percentage of Trips"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

```{r}
# Split by tag type
repeat_trucks <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(trips = n(), tag_type = first(`Pass Type`)) %>%
  ungroup() %>%
  filter(trips > 1) %>%
  count(tag_type) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

# Table
knitr::kable(
  repeat_trucks %>% rename(`Tag Type` = tag_type, `Repeat-entry Trucks` = n, `% of Repeat Trucks` = perc),
  caption = "RFID Tag Types among repeat-entry trucks"
)

# Plot
ggplot(repeat_trucks, aes(x = tag_type, y = perc, fill = tag_type)) +
  geom_col() +
  geom_text(aes(label = paste0(perc, "%")), vjust = -0.5, size = 4) +
  labs(
    title = "RFID Adoption among Repeat-entry Trucks",
    x = "Tag Type",
    y = "Percentage of Repeat Trucks"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")
```

### Fuel Type

1.  \% split of trucks by fuel type - % CNG, diesel, & petrol (if any) truck split (for total and unique RFID)

```{r}
fuel_split_trips <- MCD_truck %>%
  count(`Fuel Type`) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

# Table
knitr::kable(
  fuel_split_trips %>%
    rename(`Fuel Type` = `Fuel Type`, Trips = n, `% of Trips` = perc),
  caption = "Fuel Type split across all trips"
)

# Plot
ggplot(fuel_split_trips, aes(x = `Fuel Type`, y = perc, fill = `Fuel Type`)) +
  geom_col() +
  geom_text(aes(label = paste0(perc, "%")), vjust = -0.5, size = 4) +
  labs(
    title = "Distribution of Fuel Types (Trip-based)",
    x = "Fuel Type",
    y = "Percentage of Trips"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")
```

```{r}
fuel_split_unique <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(fuel = first(`Fuel Type`)) %>%
  ungroup() %>%
  count(fuel) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

# Table
knitr::kable(
  fuel_split_unique %>%
    rename(`Fuel Type` = fuel, `Unique Trucks` = n, `% of Trucks` = perc),
  caption = "Fuel Type split across unique trucks (RFID)"
)

# Plot
ggplot(fuel_split_unique, aes(x = fuel, y = perc, fill = fuel)) +
  geom_col() +
  geom_text(aes(label = paste0(perc, "%")), vjust = -0.5, size = 4) +
  labs(
    title = "Distribution of Fuel Types (Unique Trucks)",
    x = "Fuel Type",
    y = "Percentage of Trucks"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

## Cross tabulated insights

-   Are heavier trucks more likely to be diesel? Or are lighter trucks disproportionately CNG? (Fuel Type and Vehicle Class)

```{r}
# Cross-tab counts & percentages
fuel_vehicle <- MCD_truck %>%
  count(`Vehicle Class`, `Fuel Type`) %>%
  group_by(`Vehicle Class`) %>%
  mutate(perc = round(n / sum(n) * 100, 1)) %>%
  ungroup()

# Wide table: counts & percentages
fuel_vehicle_table <- fuel_vehicle %>%
  tidyr::pivot_wider(
    names_from = `Fuel Type`,
    values_from = c(n, perc),
    values_fill = 0
  )

knitr::kable(
  fuel_vehicle_table,
  caption = "Fuel Type by Vehicle Class (counts and percentages within class)"
)

# Stacked bar plot (percentages)
ggplot(fuel_vehicle, aes(x = `Vehicle Class`, y = perc, fill = `Fuel Type`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Fuel Type Distribution by Vehicle Class",
    x = "Vehicle Class",
    y = "Percentage within Vehicle Class",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 12)

```

```{r}
# For each unique truck, take its Vehicle Class and Fuel Type
unique_trucks <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(
    vehicle_class = first(`Vehicle Class`),
    fuel = first(`Fuel Type`)
  ) %>%
  ungroup()

# Cross-tab counts & percentages
fuel_vehicle_unique <- unique_trucks %>%
  count(vehicle_class, fuel) %>%
  group_by(vehicle_class) %>%
  mutate(perc = round(n / sum(n) * 100, 1)) %>%
  ungroup()

# Wide table: counts & percentages
fuel_vehicle_unique_table <- fuel_vehicle_unique %>%
  tidyr::pivot_wider(
    names_from = fuel,
    values_from = c(n, perc),
    values_fill = 0
  )

knitr::kable(
  fuel_vehicle_unique_table,
  caption = "Fuel Type by Vehicle Class (unique trucks, counts and percentages within class)"
)

# Stacked bar plot (percentages, unique trucks)
ggplot(fuel_vehicle_unique, aes(x = vehicle_class, y = perc, fill = fuel)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Fuel Type Distribution by Vehicle Class (Unique Trucks)",
    x = "Vehicle Class",
    y = "Percentage within Vehicle Class",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 12)

```

-   Are CNG Trucks likelier to be repeat entrants than diesel? (Fuel Type & trips per truck)

```{r}
# Trips per truck by fuel type
trips_per_truck <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(
    trips = n(),
    fuel = first(`Fuel Type`)
  ) %>%
  ungroup()

# Summarize repeat-entry behavior
repeat_summary <- trips_per_truck %>%
  mutate(repeats = ifelse(trips > 1, "Repeat Entrant", "Single Entrant")) %>%
  group_by(fuel, repeats) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(fuel) %>%
  mutate(perc = round(n / sum(n) * 100, 1))

# Table: % repeat entrants by fuel
knitr::kable(
  repeat_summary %>% tidyr::pivot_wider(
    names_from = repeats,
    values_from = c(n, perc),
    values_fill = 0
  ),
  caption = "Repeat Entry Rates by Fuel Type"
)

# Bar plot: % repeat entrants
ggplot(repeat_summary, aes(x = fuel, y = perc, fill = repeats)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Repeat Entry Likelihood by Fuel Type",
    x = "Fuel Type",
    y = "Percentage of Trucks",
    fill = "Entrant Type"
  ) +
  theme_minimal(base_size = 12)

```

```{r}
# Trips per truck by fuel type
trips_per_truck <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(
    trips = n(),
    fuel = first(`Fuel Type`)
  ) %>%
  ungroup()

# Average trips per truck (by fuel type)
avg_trips <- trips_per_truck %>%
  group_by(fuel) %>%
  summarise(
    mean_trips = round(mean(trips), 2),
    median_trips = median(trips),
    max_trips = max(trips),
    .groups = "drop"
  )

knitr::kable(
  avg_trips %>%
    rename(
      `Fuel Type` = fuel,
      `Average Trips per Truck` = mean_trips,
      `Median Trips` = median_trips,
      `Maximum Trips` = max_trips
    ),
  caption = "Trips per Truck by Fuel Type"
)

# Boxplot for distribution of trips per truck
ggplot(trips_per_truck, aes(x = fuel, y = trips, fill = fuel)) +
  geom_boxplot(outlier.alpha = 0.3) +
  scale_y_log10() +  # log scale to handle skew (many low, few very high trips)
  labs(
    title = "Distribution of Trips per Truck by Fuel Type",
    x = "Fuel Type",
    y = "Trips per Truck (log scale)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

-   Do certain plazas see more CNG or diesel truck traffic inflow? (Fuel type and toll plaza)

```{r}
# Cross-tab counts & percentages
fuel_plaza <- MCD_truck %>%
  count(`Plaza`, `Fuel Type`) %>%
  group_by(Plaza) %>%
  mutate(perc = round(n / sum(n) * 100, 1)) %>%
  ungroup()

# Wide-format table: counts & percentages
fuel_plaza_table <- fuel_plaza %>%
  tidyr::pivot_wider(
    names_from = `Fuel Type`,
    values_from = c(n, perc),
    values_fill = 0
  )

knitr::kable(
  fuel_plaza_table,
  caption = "Fuel Type Distribution by Toll Plaza (counts and % within plaza)"
)

# Stacked bar plot (percentages within plaza)
ggplot(fuel_plaza, aes(x = Plaza, y = perc, fill = `Fuel Type`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Fuel Type Distribution by Toll Plaza",
    x = "Toll Plaza",
    y = "Percentage within Plaza",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 8)+
  theme(axis.text.x = element_text(angle = 90, hjust = 0))

```

```{r}

library(knitr)

# Cross-tab counts & percentages
fuel_plaza <- MCD_truck %>%
  count(`Plaza`, `Fuel Type`) %>%
  group_by(Plaza) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup()

#====================================================
# 1. Top-N barplot (ranked by CNG share)
#====================================================
fuel_plaza_ranked <- fuel_plaza %>%
  filter(`Fuel Type` == "CNG") %>%
  arrange(desc(perc)) %>%
  slice_head(n = 15)   # top 15 plazas

top_plazas <- fuel_plaza_ranked$Plaza

p1 <- ggplot(fuel_plaza %>% filter(Plaza %in% top_plazas),
             aes(x = reorder(Plaza, perc), y = perc, fill = `Fuel Type`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  labs(
    title = "Fuel Type Distribution by Toll Plaza (Top 15 by CNG share)",
    x = "Toll Plaza",
    y = "Percentage within Plaza",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 12)

# Print plot
p1

# Print table
fuel_plaza_table_top <- fuel_plaza %>%
  filter(Plaza %in% top_plazas) %>%
  tidyr::pivot_wider(
    names_from = `Fuel Type`,
    values_from = c(n, perc),
    values_fill = 0
  )
kable(fuel_plaza_table_top, caption = "Top 15 Plazas by CNG Share: Counts and %")

#====================================================
# 2. Grouped barplot (requires plaza classification)
#====================================================
# Example classification table (replace with your own)
plaza_classification <- tibble::tibble(
  Plaza = unique(fuel_plaza$Plaza),
  Group = ifelse(grepl("East|NH", Plaza), "Corridor", "City-edge")  # dummy grouping
)

fuel_plaza_grouped <- fuel_plaza %>%
  left_join(plaza_classification, by = "Plaza") %>%
  group_by(Group, `Fuel Type`) %>%
  summarise(n = sum(n), .groups = "drop") %>%
  group_by(Group) %>%
  mutate(perc = n / sum(n))

p2 <- ggplot(fuel_plaza_grouped, aes(x = Group, y = perc, fill = `Fuel Type`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Fuel Type Distribution by Plaza Group",
    x = "Plaza Group",
    y = "Percentage",
    fill = "Fuel Type"
  ) +
  theme_minimal(base_size = 12)

# Print plot
p2

# Print table
fuel_plaza_grouped_table <- fuel_plaza_grouped %>%
  tidyr::pivot_wider(
    names_from = `Fuel Type`,
    values_from = c(n, perc),
    values_fill = 0
  )
kable(fuel_plaza_grouped_table, caption = "Fuel Type Distribution by Plaza Group: Counts and %")

#====================================================
# 3. Scatter plot: CNG share vs. total volume
#====================================================
plaza_volume <- fuel_plaza %>%
  group_by(Plaza) %>%
  summarise(
    total = sum(n),
    cng_share = sum(n[`Fuel Type` == "CNG"]) / total,
    .groups = "drop"
  )

p3 <- ggplot(plaza_volume, aes(x = total, y = cng_share)) +
  geom_point(alpha = 0.7, color = "steelblue") +
  scale_y_continuous(labels = scales::percent) +
  scale_x_log10() +
  labs(
    title = "CNG Share vs. Total Truck Entries by Plaza",
    x = "Total Truck Entries (log scale)",
    y = "CNG Share"
  ) +
  theme_minimal(base_size = 12)

# Print plot
p3

# Print table
plaza_volume_table <- plaza_volume %>%
  arrange(desc(cng_share)) %>%
  mutate(cng_share = scales::percent(cng_share, accuracy = 0.1))
kable(plaza_volume_table, caption = "Plaza-level CNG Share and Total Entries")

```

-   At what times of day do CNG trucks tend to ply vs. diesel trucks? (Fuel Type and time of day)

```{r}
# Prepare hourly data
fuel_hourly <- MCD_truck %>%
  count(`Fuel Type`, Hour) %>%
  group_by(`Fuel Type`) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup()

# Plot with shaded restricted window
ggplot(fuel_hourly, aes(x = Hour, y = perc, color = `Fuel Type`)) +
  # Shaded band for restricted hours (6:00–22:00)
  annotate(
    "rect", xmin = 6, xmax = 22, ymin = 0, ymax = Inf,
    alpha = 0.2, fill = "grey70"
  ) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.5) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = 0:23) +
  labs(
    title = "Diurnal Pattern of Truck Entries by Fuel Type",
    subtitle = "Shaded area = Restricted hours (6 AM – 10 PM)",
    x = "Hour of Day",
    y = "Share of Daily Traffic",
    color = "Fuel Type"
  ) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor.x = element_blank())

```

-   Are lighter 2-axle trucks the ones repeating most often vs. heavier long-haul trucks? (Axle Class & Trips per Truck)

```{r}
# Trips per truck, tagged with axle class
trips_per_truck_axle <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(
    trips = n(),
    axle = first(`Vehicle Class`)
  ) %>%
  ungroup()

# Summary statistics
axle_summary <- trips_per_truck_axle %>%
  group_by(axle) %>%
  summarise(
    mean_trips = round(mean(trips), 2),
    median_trips = median(trips),
    max_trips = max(trips),
    n_trucks = n(),
    .groups = "drop"
  )

knitr::kable(
  axle_summary %>%
    rename(
      `Vehicle Class`  = axle,
      `Average Trips per Truck` = mean_trips,
      `Median Trips` = median_trips,
      `Maximum Trips` = max_trips,
      `Number of Unique Trucks` = n_trucks
    ),
  caption = "Trips per Truck by Axle Class"
)

# Boxplot (log scale, to show heavy skew)
ggplot(trips_per_truck_axle, aes(x = axle, y = trips, fill = axle)) +
  geom_boxplot(outlier.alpha = 0.3) +
  scale_y_log10() +
  labs(
    title = "Distribution of Trips per Truck by Axle Class",
    x = "Axle Class",
    y = "Trips per Truck (log scale)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

```{r}
# Trips per truck, tagged with axle class and fuel type
trips_per_truck_af <- MCD_truck %>%
  group_by(RFID) %>%
  summarise(
    trips = n(),
    axle = first(`Vehicle Class`),
    fuel = first(`Fuel Type`)
  ) %>%
  ungroup()

# Summary statistics
axle_fuel_summary <- trips_per_truck_af %>%
  group_by(axle, fuel) %>%
  summarise(
    mean_trips = round(mean(trips), 2),
    median_trips = median(trips),
    max_trips = max(trips),
    n_trucks = n(),
    .groups = "drop"
  )

knitr::kable(
  axle_fuel_summary %>%
    rename(
      `Vehicle Class` = axle,
      `Fuel Type` = fuel,
      `Average Trips per Truck` = mean_trips,
      `Median Trips` = median_trips,
      `Maximum Trips` = max_trips,
      `Number of Unique Trucks` = n_trucks
    ),
  caption = "Trips per Truck by Axle Class and Fuel Type"
)

# Boxplot (log scale), faceted by fuel type
ggplot(trips_per_truck_af, aes(x = axle, y = trips, fill = axle)) +
  geom_boxplot(outlier.alpha = 0.3) +
  scale_y_log10() +
  facet_wrap(~ fuel) +
  labs(
    title = "Distribution of Trips per Truck by Axle Class & Fuel Type",
    subtitle = "Faceted by Fuel Type (CNG vs Diesel)",
    x = "Axle Class",
    y = "Trips per Truck (log scale)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

-   Which plazas disproportionately see 3/4+ axle heavy-duty trucks? (we can use this to revise the 'major/minor' classifications that we/MCD/CSE tend to use) (Axle Class and toll plaza)

```{r}
# Compute axle share at each plaza
axle_plaza <- MCD_truck %>%
  count(Plaza, `Vehicle Class`) %>%
  group_by(Plaza) %>%
  mutate(total = sum(n)) %>%
  filter(total > 100) %>%   # only plazas with >100 trucks
  mutate(share = n / sum(n)) %>%
  ungroup()

# Plot share of each axle type by plaza
ggplot(axle_plaza, aes(x = Plaza, y = share, fill = `Vehicle Class`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Axle Class Distribution by Plaza",
    subtitle = "Relative share of 2-, 3-, and 4+ axle trucks at each entry point",
    x = "Plaza",
    y = "Share of Truck Entries",
    fill = "Axle Class"
  ) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))

```

```{r}
# 1. Plaza-level CNG share & total truck volume
plaza_cng <- MCD_truck %>%
  count(Plaza, `Fuel Type`) %>%
  group_by(Plaza) %>%
  mutate(total = sum(n)) %>%
  filter(total > 100) %>%   # only plazas with >100 trucks
  summarise(
    total = unique(total),
    cng_share = sum(n[`Fuel Type` == "CNG"], na.rm = TRUE) / total,
    .groups = "drop"
  )

# 2. Axle distribution by plaza
axle_plaza <- MCD_truck %>%
  filter(Plaza %in% plaza_cng$Plaza) %>%
  count(Plaza, `Vehicle Class`) %>%
  group_by(Plaza) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup() %>%
  left_join(plaza_cng, by = "Plaza")   # attach CNG share info

# 3. Plot: Axle distribution with plazas ordered by CNG share
ggplot(axle_plaza, aes(x = reorder(Plaza, cng_share), y = perc, fill = `Vehicle Class`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  labs(
    title = "Axle Class Distribution by Toll Plaza (ordered by CNG share, >100 trucks)",
    x = "Toll Plaza (ordered by CNG share)",
    y = "Percentage of Trucks",
    fill = "Vehicle Class"
  ) +
  theme_minimal(base_size = 8)

```

```{r}
# Table: Axle distribution by plaza, with total volume & CNG share
axle_plaza_table <- axle_plaza %>%
  select(Plaza, `Vehicle Class`, perc, n, total, cng_share) %>%
  tidyr::pivot_wider(
    names_from = `Vehicle Class`,
    values_from = c(n, perc),
    values_fill = 0
  ) %>%
  arrange(desc(cng_share)) %>%  # order by CNG share
  mutate(cng_share = scales::percent(cng_share, accuracy = 0.1))

knitr::kable(
  axle_plaza_table,
  caption = "Plaza-wise Axle Distribution, Total Truck Volume, and CNG Share (Plazas with >100 trucks)"
)

```

-   Are periodic tags mostly held by high frequency trucks? (RFID tag type and trips per truck)

```{r}
# 1. Trips per truck
trips_per_truck <- MCD_truck %>%
  group_by(`RFID`, `Pass Type`) %>%
  summarise(trips = n(), .groups = "drop")

# 2. Summary stats by tag type
rfid_summary <- trips_per_truck %>%
  group_by(`Pass Type`) %>%
  summarise(
    mean_trips = mean(trips),
    median_trips = median(trips),
    p90_trips = quantile(trips, 0.9),
    max_trips = max(trips),
    n_trucks = n(),
    .groups = "drop"
  )

knitr::kable(
  rfid_summary,
  caption = "Trips per Truck by RFID Tag Type"
)

# 3. Distribution plot: trips per truck by tag type
ggplot(trips_per_truck, aes(x = trips, fill = `Pass Type`)) +
  geom_histogram(binwidth = 1, alpha = 0.7, position = "dodge") +
  scale_x_continuous(limits = c(0, 50)) +
  scale_y_log10() +
  labs(
    title = "Distribution of Trips per Truck by RFID Tag Type (log scale, side-by-side)",
    x = "Trips per Truck",
    y = "Number of Trucks (log scale)",
    fill = "Tag Type"
  ) +
  theme_minimal(base_size = 12)


```

-   Which plazas experience peak traffic flow at night vs. day? (Toll plaza and time of day)

```{r}

# 3. Classify time of day (day vs night)
MCD_truck <- MCD_truck %>%
  mutate(
    tod = cut(
      Hour,
      breaks = c(-1, 5, 9, 15, 21, 23),  # bins: 0–5, 6–9, 10–15, 16–21, 22–23
      labels = c("Night (10 pm–6 am)", 
                 "Morning (6–10 am)", 
                 "Midday (10 am–4 pm)", 
                 "Evening (4–10 pm)", 
                 "Night (10 pm–6 am)")
    )
  )

# Compute plaza volumes and filter >100 trucks
plaza_vols <- MCD_truck %>%
  count(Plaza) %>%
  filter(n > 200)

# Aggregate by plaza × time of day
plaza_tod <- MCD_truck %>%
  filter(Plaza %in% plaza_vols$Plaza) %>%
  count(Plaza, tod) %>%
  group_by(Plaza) %>%
  mutate(perc = n / sum(n)) %>%
  ungroup()

# Compute night share per plaza
night_share <- plaza_tod %>%
  filter(tod == "Night (10 pm–6 am)") %>%
  select(Plaza, night_perc = perc)

# Join back and reorder plazas by night share
plaza_tod <- plaza_tod %>%
  left_join(night_share, by = "Plaza") %>%
  mutate(Plaza = reorder(Plaza, night_perc))

# Plot
ggplot(plaza_tod, aes(x = Plaza, y = perc, fill = tod)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  labs(
    title = "Traffic Flow by Time of Day and Plaza (>100 trucks)",
    x = "Toll Plaza (ordered by night share)",
    y = "Share of Trucks",
    fill = "Time of Day"
  ) +
  theme_minimal(base_size = 8)


```

-   For each data-point (fuel, axle, tag type, plaza), compare share of unique trucks vs share of total entries to highlight how many repeats trips are being made (unique vs total by segment (overall comparison of sorts))

```{r}
# Function to compute unique vs total shares for a variable
segment_shares <- function(df, var) {
  var <- rlang::sym(var)
  
  total_share <- df %>%
    count(!!var, name = "total_trips") %>%
    mutate(total_share = total_trips / sum(total_trips))
  
  unique_share <- df %>%
    distinct(RFID, !!var) %>%   # unique trucks by category
    count(!!var, name = "unique_trucks") %>%
    mutate(unique_share = unique_trucks / sum(unique_trucks))
  
  total_share %>%
    left_join(unique_share, by = rlang::as_name(var)) %>%
    mutate(diff = total_share - unique_share)
    # diff = gap (positive = repeat-heavy, negative = under-represented in repeats)
}

# ---- Fuel ----
fuel_share <- segment_shares(MCD_truck, "Fuel Type")

# ---- Axle Class ----
axle_share <- segment_shares(MCD_truck, "Vehicle Class")

# ---- Tag Type ----
tag_share <- segment_shares(MCD_truck, "Pass Type")

# ---- Plaza ---- (filter to >100 trucks to avoid noise)
plaza_share <- MCD_truck %>%
  add_count(Plaza, name = "plaza_total") %>%
  filter(plaza_total > 100) %>%
  segment_shares("Plaza")

# Example: show fuel results in a table
knitr::kable(
  fuel_share,
  digits = 2,
  caption = "Fuel Type: Unique vs. Total Trip Shares"
)
```

```{r}
ggplot(fuel_share, aes(x = `Fuel Type`)) +
  geom_col(aes(y = total_share, fill = "Total Trips"), position = "dodge") +
  geom_col(aes(y = unique_share, fill = "Unique Trucks"), position = "dodge") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Fuel Type: Share of Unique Trucks vs. Total Trips",
    y = "Share (%)",
    x = NULL,
    fill = ""
  ) +
  theme_minimal(base_size = 12)

```

-   trucks entering at one toll plaza and then reentering through another toll plaza (i.e., bypassing Delhi) - hypothesis is that this number is rather small

```{r}
truck_plaza_counts <- MCD_truck %>%
  group_by(`RFID`) %>%
  summarise(
    n_plazas = n_distinct(Plaza),
    total_trips = n()
  ) %>%
  ungroup()

# Distribution of how many trucks use multiple plazas
knitr::kable(
  truck_plaza_counts %>%
    count(n_plazas) %>%
    mutate(perc = round(n / sum(n) * 100, 2)),
  caption = "Number of Plazas Visited per Truck"
)

# n_plazas = 2+ is rare means it supports hypothesis.
```

```{r}
truck_sequences <- MCD_truck %>%
  group_by(RFID, Date) %>%
  mutate(next_plaza = lead(Plaza)) %>%
  ungroup() %>%
  filter(!is.na(next_plaza) & Plaza != next_plaza)

# Count plaza-to-plaza transitions
plaza_transitions <- truck_sequences %>%
  count(Plaza, next_plaza, sort = TRUE) %>%
  mutate(perc = round(n / sum(n) * 100)) %>% 
  filter(perc>0)

knitr::kable(plaza_transitions, caption = "Top Plaza-to-Plaza Transitions (possible bypasses)")

```

```{r}

# Edges, with log scale applied
edges <- plaza_transitions %>%
  mutate(log_n = log(n)) %>% 
  filter(log_n>0)

# Node-level totals (all trips per plaza)
plaza_nodes <- MCD_truck %>%
  count(Plaza, name = "total_trucks") %>% 
  filter(Plaza %in% edges$Plaza | Plaza %in% edges$next_plaza)

# Build igraph object
g <- igraph::graph_from_data_frame(d = edges, vertices = plaza_nodes , directed = TRUE)

# Compute layout with more spacing
set.seed(123)  # reproducible
lay <- igraph::layout_with_fr(g, niter = 1000, grid = "nogrid")

# Plot network
ggraph(g, layout = lay) +
  geom_edge_link(
    aes(width = log_n),   # use log-transformed weights
    alpha = 0.5,
    arrow = arrow(length = unit(4, "mm")),
    end_cap = circle(3, 'mm'),
    color = "grey50"
  ) +
  geom_node_point(aes(size = total_trucks, color = total_trucks)) +
  ggrepel::geom_text_repel(aes(x = .data$x, y = .data$y,label = name), size = 3) +
  scale_edge_width(range = c(0.5, 2)) +
  scale_size_continuous(range = c(1, 10)) +
  scale_color_viridis_c(option = "plasma") +
  labs(
    title = "Top Plaza-to-Plaza Truck Transitions",
    subtitle = "Edges proportional to log(transitions); Nodes proportional to total truck entries",
    color = "Total Trucks",
    edge_width = "log(Transitions)"
  ) +
  theme_void()

```

```{r}
# Cross-tab counts
axle_rfid <- MCD_truck %>%
  distinct(RFID, .keep_all = TRUE) %>% 
  count(`Vehicle Class`, `Pass Type`) %>%
  group_by(`Vehicle Class`) %>%
  mutate(perc = round(n / sum(n) * 100, 1)) %>%
  ungroup()

# Table
knitr::kable(
  axle_rfid %>%
    tidyr::pivot_wider(
      names_from = `Pass Type`,
      values_from = c(n, perc),
      values_fill = 0
    ),
  caption = "Axle Type vs RFID Tag Type (counts and percentages)"
)

# Stacked bar plot
ggplot(axle_rfid, aes(x = `Vehicle Class`, y = perc, fill = `Pass Type`)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "RFID Tag Type Distribution by Axle Type",
    x = "Axle Type",
    y = "Percentage within Axle Type",
    fill = "RFID Tag Type"
  ) +
  theme_minimal(base_size = 12)

```

# Analysis of OD data

```{r}
# read in files
survey_1 <- read_csv("Analysis_Survey/Input/Survey_part_1.csv")
survey_2 <- read_csv("Analysis_Survey/Input/Survey_part_2.csv")

survey_data <- bind_rows(survey_1, survey_2)
rm(survey_1, survey_2)

axle_loads <- read_csv("Analysis_Survey/Input/axle_loads.csv")

```

```{r}
# Basic preprocessing

# Classifying the directions as coming "In" or going "Out" of Delhi
survey_data <-
  survey_data %>% 
  mutate(Direction_bin = "In") %>% 
  mutate(
    Direction_bin = 
      ifelse(
        grepl(
          "^Delhi",
          Direction),
        "Out",
        Direction_bin)) %>% 
  mutate(
    Direction_bin = 
      ifelse(
        grepl(
          "^Auchandi",
          Direction),
        "Out",
        Direction_bin))

# Harmonizing the shift timings

survey_data <-
  survey_data %>% 
  mutate(Sfift = str_replace(Sfift, " ", "-"))


# Time
# Check survey dates and send to RG


# Improve some Origin locations
survey_data <-
  survey_data %>% 
  mutate(Origin = ifelse(str_detect(Origin, "Gurgaon"),   "Gurugram", Origin)) %>% 
  mutate(Origin = ifelse(str_equal(Origin,"Hariyana"), "Haryana", Origin)) %>% 
  mutate(Origin = ifelse(str_detect(Origin, "dnd|noida"),
                         "Noida",
                         Origin)) %>% 
  
  

# correct fuel type
survey_data <-
  survey_data %>% 
  mutate(Fuel_Type = ifelse(`Fule Type`=="Cng", "CNG", `Fule Type`)) %>% 
  select(-`Fule Type`)

# registration number to caps
survey_data<-
  survey_data %>% 
  mutate(`Full Reg No` = str_to_upper(`Full Reg No`)) %>% 
  filter(`Full Reg No`!=0)
axle_loads$`Full Reg No`  <- str_to_upper(axle_loads$`Full Reg No`)


# Change the "---" in return commodity to Empty

survey_data<-
  survey_data %>% 
  mutate(
    `Return Trip Commodity Type`= 
      ifelse(`Return Trip Commodity Type`=="---", 
             "Empty", 
             `Return Trip Commodity Type`))


```

## Some basic statistics

```{r}
# Sample size - Plaza and directions

Distribution <-
  survey_data %>% 
  group_by(`Location Name`, Direction_bin) %>% 
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  summarize(count = n()) %>% 
  pivot_wider(names_from = Direction_bin, values_from = count, values_fill = 0)

# Table
knitr::kable(Distribution, caption = "Distribution of trucks surveyed by Toll Plaza and Direction of travel")
```


```{r}
temp <-
  survey_data %>% 
  group_by(`Location Name`) %>% 
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  summarize(count = n(), .groups="drop") %>% 
  mutate(Percentage = round(count*100/sum(count),1)) %>% 
  select(-count) %>% 
  arrange(-Percentage)

kable(temp)
```


```{r}
temp <-
  survey_data %>% 
  group_by(Direction_bin) %>% 
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(Percentage = round(count*100/sum(count),1)) %>% 
  select(-count) %>% 
  rename("Direction"="Direction_bin")

kable(temp)
```

```{r}
temp <-
  survey_data %>% 
  group_by(`Full Reg No`) %>%
  distinct(`Location Name`, .keep_all = TRUE) %>% 
  summarise(count = n())

#kable(temp)
# avg no. of locations per truck
print(sum(temp$count)/nrow(temp))

# % of trucks seen at multiple locations
temp<-
  survey_data %>% 
  group_by(`Full Reg No`) %>% 
  distinct(`Location Name`, .keep_all = TRUE) %>% 
  summarise(count = n()) %>% 
  filter(count>1)

print(nrow(temp)*100/length(unique(survey_data$`Full Reg No`)))

# % of trucks seen going in multiple directions
temp<-
  survey_data %>% 
  group_by(`Full Reg No`) %>% 
  distinct(Direction_bin, .keep_all = TRUE) %>% 
  summarise(count = n()) %>% 
  filter(count>1)

print(nrow(temp)*100/length(unique(survey_data$`Full Reg No`)))

```
```{r}
# Timing - shift 
table(survey_data$Sfift)
temp <-
  survey_data %>% 
  group_by(Sfift) %>% 
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  summarise(count = n()) %>% 
  rename("Shift"="Sfift") %>% 
  mutate(Percent = round(count*100/sum(count),1)) %>% 
  arrange(-Percent)

kable(temp)

```

```{r}
# average number of shifts per truck
temp <-
  survey_data %>% 
  group_by(`Full Reg No`) %>% 
  distinct(Sfift, .keep_all = TRUE) %>% 
  summarise(count=n())

print(sum(temp$count)/nrow(temp))

#average number by reg state might also be interesting?
```

```{r}
# average time between repeat entries
temp <-
  survey_data %>% 
  add_count(`Full Reg No`) %>% 
  filter(n>1)

# now get the timestamps using the images, so that i can answer this question.
  

```


```{r}
# Percentage of trucks in multiple shifts
temp<-
  survey_data %>% 
  group_by(`Full Reg No`) %>% 
  distinct(Sfift, .keep_all = TRUE) %>% 
  summarise(count = n()) %>% 
  filter(count>1)

print(nrow(temp)*100/length(unique(survey_data$`Full Reg No`)))

```


```{r}
# avg no, of truck entries per truck by type
temp <-
  survey_data %>% 
  group_by(`Vehicle Type`) %>% 
  summarise(count=n(), .groups = "drop") %>% 
  mutate(Percent = round(count*100/sum(count),1))

kable(temp)

# same, but unique
temp <-
  survey_data %>% 
  group_by(`Vehicle Type`) %>% 
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  summarise(count=n(), .groups = "drop") %>% 
  mutate(Percent = round(count*100/sum(count),1))

kable(temp)

```

```{r}
# average no. of entries per truck by type
temp <-
  survey_data %>%
  #filter(Direction_bin=="In") %>% 
  add_count(`Full Reg No`) %>%
  select(`Full Reg No`, n, `Vehicle Type`) %>% 
  distinct() %>% 
  select(-`Full Reg No`) %>% 
  add_count(`Vehicle Type`) %>% 
  group_by(`Vehicle Type`) %>% 
  summarise(`Average entries` = round(sum(n)/nn, 2)) %>% 
  distinct()
  
kable(temp)

# would be nicer as a distribution

```


```{r}
# Percentage of trucks seen once, 2-5, 5-10, 10+ times by type

temp <-
  survey_data %>% 
  group_by(`Full Reg No`, `Vehicle Type`) %>% 
  summarise(count = n()) %>%
  group_by(`Vehicle Type`, count) %>% 
  summarize(trucks = n()) %>% 
  pivot_wider(names_from = `Vehicle Type`, values_from = trucks, values_fill = 0)

kable(temp)

temp <-
  temp %>% 
  mutate(across(-count, ~ round(.x / sum(.x) * 100, 2))) 

kable(temp)

```

```{r}
#1. Avg. no. of entries per unique truck (entries divided by unique trucks)
print(nrow(survey_data)/length(unique(survey_data$`Full Reg No`)))
#2. % of trucks seen once, 2-5, 5-10, 10+ times
temp <-
  survey_data %>% 
  group_by(`Full Reg No`) %>% 
  summarize(count = n()) %>% 
  group_by(count) %>% 
  summarise(n = n()) %>% 
  mutate(`%` = round(n*100/sum(n), 2))

kable(temp)

#3. Share of traffic generated by top 10% most frequent trucks (share of trucks vs share of trips)
#4. Avg. time between consecutive entries per truck
```


```{r}
# pie charts of the vehicle fuel types
fuel_type <- 
  survey_data %>%
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  group_by(Fuel_Type , `Vehicle Type`) %>%
  summarise(count = n(), .groups = "drop")

# --- 1. Fuel Type distribution ---
fuel_summary <- fuel_type %>%
  group_by(Fuel_Type) %>%
  summarise(count = sum(count), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)

ggplot(fuel_summary, aes(x = "", y = count, fill = Fuel_Type)) +
  geom_col(color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(round(prop, 1), "%")),
            position = position_stack(vjust = 0.5), color = "white") +
  theme_void() +
  labs(title = "Fuel Type Distribution")
```


```{r}
# --- 2. Vehicle Class distribution ---
vehicle_summary <- 
    fuel_type %>%
  group_by(`Vehicle Type` ) %>%
  distinct( )
  summarise(count = sum(count), .groups = "drop") %>%
  mutate(Percent = round(count *100 / sum(count),1))

kable(vehicle_summary)

ggplot(vehicle_summary, aes(x = "", y = count, fill = `Vehicle Type`)) +
  geom_col(color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(round(Percent, 1), "%")),
            position = position_stack(vjust = 0.5), color = "white") +
  theme_void() +
  labs(title = "Vehicle Class Distribution")

```


```{r}
# State from reg number

# get first two alphabets

registration_no <-
  survey_data %>% 
  mutate(reg_state=toupper(str_extract(`Full Reg No` , "(?i)^[a-z]{2}")) )%>% 
  group_by(reg_state) %>% 
  summarize(count = n(), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100) %>%
  mutate(reg_state = ifelse(prop<1, "Other", reg_state)) %>% 
  group_by(reg_state) %>% 
  summarize(count = sum(count), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)

ggplot(registration_no, aes(x = reorder(reg_state, -count), y = count, fill = reg_state)) +
  geom_col(color = "white") +
  geom_text(aes(label = paste0(round(prop, 1), "%")),
            vjust = -0.5, color = "black") +
  theme_minimal() +
  labs(
    title = "Registration State Distribution",
    x = "State Code",
    y = "Count"
  ) +
  theme(legend.position = "none")

```


```{r}
# State of origin

origin_state <-
  survey_data %>% 
  group_by(OState) %>% 
  summarize(count= n(), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)%>%
  mutate(or_state = ifelse(prop<1, "Other", OState)) %>% 
  group_by(or_state) %>% 
  summarize(count = sum(count), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)


ggplot(origin_state, aes(x = reorder(or_state, -count), y = count, fill = or_state)) +
  geom_col(color = "white") +
  geom_text(aes(label = paste0(round(prop, 1), "%")),
            vjust = -0.5, color = "black") +
  theme_minimal() +
  labs(
    title = "Origin State Distribution",
    x = "State",
    y = "Count"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )
```
```{r}
# % distribution by origin city 


# 1 - top 20 cities with the 

temp <-
  survey_data %>% 
  mutate(Origin = ifelse(Origin==OState, "city unknown", Origin)) %>% 
  #mutate(Origin = ifelse(Direction_bin=="Out", "Delhi", Origin)) %>% 
  filter(Direction_bin=="In") %>% 
  group_by(Origin) %>% 
  distinct(`Full Reg No`, .keep_all = TRUE) %>% 
  summarize(n = n(), .groups = "drop") %>%
  mutate(`.  %  .` = round(n*100/sum(n),1)) %>% 
  arrange(-`.  %  .`) %>% 
  filter(Origin!="city unknown") %>% 
  mutate(`% known` = round(n*100/sum(n),1)) %>% 
  head(20)

kable(temp)
```

```{r}
# average number of entries per truck per city


# % trucks repeating same origin vs multiple origins
```

```{r}

```


```{r}
# Destination in Delhi?

destinations_delhi <- 
  survey_data %>% 
  filter(DState=="Delhi") %>% 
  group_by(Destination) %>% 
  summarize(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count) * 100) %>% 
  mutate(Destination=ifelse(prop<1,"Other", Destination)) %>% 
  group_by(Destination) %>% 
  summarize(count = sum(count), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)

ggplot(destinations_delhi, aes(x = reorder(Destination, -count), y = count, fill = Destination)) +
  geom_col(color = "white") +
  geom_text(aes(label = paste0(round(prop, 1), "%")),
            vjust = -0.5, color = "black") +
  theme_minimal() +
  labs(
    title = "Destination (in Delhi) Distribution",
    x = "Place",
    y = "Count"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

```

```{r}

# Fuel type
table(survey_data$Fuel_Type)
```


```{r}
# BS Norms

bs_norms <-
  survey_data %>% 
  filter(`BS norms` %in% c(3,4,6)) %>% 
  mutate(`BS norms` = paste("BS", as.roman(`BS norms`))) %>% 
  group_by(`BS norms`, Fuel_Type) %>% 
  summarize(count = n())


kable(bs_norms %>% pivot_wider(names_from = Fuel_Type, values_from = count, values_fill = 0))

ggplot(bs_norms, aes(x = factor(Fuel_Type), y = count, fill = `BS norms`)) +
  geom_col(position = "dodge") +
  labs(
    title = "Distribution of BS Norms by Fuel Type",
    x = "Fuel Type",
    y = "Count",
    fill = "BS Norms"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5)
  )

```


```{r}
# Load and vehicle weight


```


```{r}
# Registration Year

age_fuel <- survey_data %>% 
  mutate(Age = 2025 - `Registration year`) %>% 
  group_by(Fuel_Type , Age) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  group_by(Fuel_Type) %>% 
  mutate(prop = round(count / sum(count) * 100,1)) %>% 
  pivot_wider(names_from = Fuel_Type, values_from = count, values_fill = 0)


kable(age_fuel)

ggplot(age_fuel, aes(x = Age, y = prop, fill = Fuel_Type)) +
  # change into line graph
  geom_area(position = "identity", alpha = 0.4, color = "black") +
  scale_y_continuous(limits = c(0, 20)) +
  labs(
    title = "Vehicle Age Distribution by Fuel Type",
    x = "Vehicle Age (Years)",
    y = "Percentage",
    fill = "Fuel Type"
  ) +
  theme_minimal()
```


```{r}  
ggplot(age_fuel, aes(x = Age, y = prop, fill = Fuel_Type)) +
  geom_area(position = "identity", alpha = 0.3) +
  geom_smooth(aes(color = Fuel_Type), 
              se = FALSE, 
              method = "loess", 
              span = 0.6, 
              size = 1.2) +
  scale_x_continuous(limits = c(0, 15)) +
  labs(
    title = "Vehicle Age Distribution by Fuel Type",
    x = "Vehicle Age (Years)",
    y = "Percentage",
    fill = "Fuel Type",
    color = "Fuel Type"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```


```{r}
# Daily distance traveled

temp <-
  survey_data %>% 
  group_by(`Daily distance travelled`, `Vehicle Type`) %>% 
  summarize(count=n()) %>%
  mutate(totaldist = `Daily distance travelled`*count) %>% 
  group_by(`Vehicle Type`) %>% 
  summarise(count=sum(count), 
            distance = sum(totaldist)) %>% 
  mutate(Average_Distance = 
           round(distance/count,1)) %>% 
  select(`Vehicle Type`, Average_Distance)

kable(temp)
  

```


```{r}
# vehicle commodity 
temp <-
  survey_data %>% 
  group_by(`Commodity Type`) %>% 
  summarize(count = n(), .groups = "drop") %>%
  filter(count>20) %>% 
  filter(`Commodity Type`!= "Empty") %>% 
  mutate(prop = count / sum(count) * 100)

ggplot(temp, aes(x = reorder(`Commodity Type`, -count), y = count, fill = `Commodity Type`)) +
  geom_col(color = "white") +
  geom_text(aes(label = paste0(round(prop), "%")),
            vjust = -0.5, color = "black", size = 2) +
  theme_minimal() +
  labs(
    title = "Commodity Distribution",
    x = "Commodity",
    y = "Count"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

```


```{r}
# destination state

dest_state <-
  survey_data %>% 
  group_by(DState) %>% 
  summarize(count = n(), .groups = "drop") %>% 
  mutate(prop = count *100 / sum(count)) %>% 
  mutate(DState =ifelse(prop<0.5,"Other", DState)) %>% 
  group_by(DState) %>% 
  summarize(count = sum(count), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)

ggplot(dest_state, aes(x = reorder(DState, -count), y = count, fill = DState)) +
  geom_col(color = "white") +
  geom_text(aes(label = paste0(round(prop, 1), "%")),
            vjust = -0.5, color = "black") +
  ylim(0,4500)+
  theme_minimal() +
  labs(
    title = "Destination State Distribution",
    x = "State",
    y = "Count"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5)
  )

```


```{r}
# Maintenance frequency

```


```{r}
# Vehicle Weight

```

```{r}
# bar graph at city origin level

```


## Cross-tabulated insights



```{r}
# distance travelled with commodity 
# destination state

dest_state <-
  survey_data %>% 
  group_by(Dest_State) %>% 
  summarize(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count) * 100) %>% 
  mutate(Dest_State =ifelse(prop<0.5,"Other", Dest_State)) %>% 
  group_by(Dest_State) %>% 
  summarize(count = sum(count), .groups = "drop") %>%
  mutate(prop = count / sum(count) * 100)

ggplot(dest_state, aes(x = reorder(Dest_State, -count), y = count, fill = Dest_State)) +
  geom_col(color = "white") +
  geom_text(aes(label = paste0(round(prop, 1), "%")),
            vjust = -0.5, color = "black") +
  ylim(0,2000)+
  theme_minimal() +
  labs(
    title = "Destination State Distribution",
    x = "State",
    y = "Count"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5)
  )


```




```{r}

# destination city plots - for 


```


### Are older trucks disproportionately high-frequency entrants?

```{r}
# 



```

### Do BS III/IV trucks carry heavier loads, amplifying emissions impact?

```{r}

```

### Are diesel trucks dominant across all weight classes, and are CNG/LNG limited to lighter trucks?

```{r}

```

### Which OD corridors are dominated by older emission-standard trucks?

```{r}

```

### Are company fleets newer/cleaner than self-owned trucks?

```{r}

```

### Do self-owned trucks tend to be older and more polluting?

```{r}

```

### Do older trucks travel longer daily distances, magnifying emissions?

```{r}

```


### Is there a commodity bias (e.g., construction, coal, perishables) towards older trucks?

```{r}

```

### Are frequent night-shift entrants more likely to be older diesel trucks?

```{r}

```

### What share of repeat entries is explained by a small percentage of trucks, and are these dirtier vehicles?

```{r}

```

### Are empty return trips more common among older vehicles (higher VKT per payload)?

```{r}

```

### Do certain makes/models have higher repeat frequency and tend to be older norms?

```{r}

```

### How does maintenance frequency change with age and emission norms?

```{r}

```

### Are high-GVW trucks disproportionately pre-BS-IV

```{r}

```

### Do certain OD corridors see more empty backhauls?

```{r}

```


### Do company fleets maintain trucks more regularly than self-owners?

```{r}

```

### Are certain commodities (e.g., perishables) more likely to use newer BS-VI fleets?

```{r}

```

### Do alternative fuel trucks cluster in specific corridors (Delhi-UP vs Delhi-RJ)?

### Are long-distance trips (e.g. >500km/day) mostly diesel, short-hauls more CNG?

### Do night-shift entries carry specific commodities (coal, cement)?

### Are overloaded trucks (weight>permissible) concentrated in older fleets?

### Do new BS-VI trucks have lower maintenance cycles than BS-III/IV?

### Are specific OEMs leading adoption of BS-VI/alternative fuels?

### Are lighter CNG trucks primarily last-mile (Delhi-NCR trips) vs heavy diesel long-haul?



